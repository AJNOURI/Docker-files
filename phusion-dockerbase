# Use phusion/baseimage as base image. To make your builds
# reproducible, make sure you lock down to a specific version, not
# to `latest`! See
# https://github.com/phusion/baseimage-docker/blob/master/Changelog.md
# for a list of version numbers.
FROM phusion/baseimage:0.9.16

# Use baseimage-docker's init system.
CMD ["/sbin/my_init"]

# Tell debconf to run in non-interactive mode
ENV DEBIAN_FRONTEND noninteractive


# Update the source list for appropriate repository, trusty 14.04 LTS, in this case.
# Generated from:
# https://wiki.ubuntu.com/DevelopmentCodeNames
# http://repogen.simplylinux.ch/


RUN echo "deb http://fr.archive.ubuntu.com/ubuntu/ trusty main" >> /etc/apt/sources.list \
    && echo "deb-src http://fr.archive.ubuntu.com/ubuntu/ trusty main universe" >> /etc/apt/sources.list \
    && echo "deb http://fr.archive.ubuntu.com/ubuntu/ trusty-security main" >> /etc/apt/sources.list \
    && echo "deb http://fr.archive.ubuntu.com/ubuntu/ trusty-updates main" >> /etc/apt/sources.list \
    && echo "deb-src http://fr.archive.ubuntu.com/ubuntu/ trusty-security main universe" >> /etc/apt/sources.list \
    && echo "deb-src http://fr.archive.ubuntu.com/ubuntu/ trusty-updates main universe" >> /etc/apt/sources.list

# Miscellaneous tools
RUN apt-get update && apt-get install -y wget iperf inetutils-traceroute iputils-tracepath \
    mtr dnsutils sip-tester build-essential sip-tester tcpdump packeth && mkdir voip

WORKDIR /voip

# Some useful .pcap .xml files for voip testing
RUN wget hpnouri.free.fr/sip/dtmf_2833_1.pcap \
    && wget hpnouri.free.fr/sip/g711a.pcap \
    && wget http://sipp.sourceforge.net/doc/uac.xml \
    && wget http://sipp.sourceforge.net/doc/uac_pcap.xml \
    && sed -i 's/pcap\/g711a.pcap/\/tmp\/g711a.pcap/g' uac_pcap.xml \
    && sed -i 's/pcap\/dtmf_2833_1.pcap/\/tmp\/dtmf_2833_1.pcap/g' uac_pcap.xml

# install pjsua voip testing tool
# executable to use: /tmp/pjproject-2.3/pjsip-apps/bin/pjsua-x86_64-unknown-linux-gnu
RUN wget http://www.pjsip.org/release/2.3/pjproject-2.3.tar.bz2 \
    &&  tar -jxvf pjproject-2.3.tar.bz2
WORKDIR pjproject-2.3

RUN ./configure && make dep && make clean && make
WORKDIR /voip
# Clean up APT
RUN apt-get clean && rm -rf /var/lib/apt/lists/* \
    && touch /etc/service/syslog-forwarder/down \
    && rm pjproject-2.3.tar.bz2

